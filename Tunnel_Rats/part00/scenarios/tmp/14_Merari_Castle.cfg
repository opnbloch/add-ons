#textdomain wesnoth-Black_River_Tutorial

	{~add-ons/Black_River_Tutorial/macros/utils.cfg}
	{~add-ons/Black_River_Tutorial/macros/journey.cfg}
	{~add-ons/Black_River_Tutorial/macros/story.cfg}
	{~add-ons/Black_River_Tutorial/macros/music-lists.cfg}
	{~add-ons/Black_River_Tutorial/macros/scenario02-macros.cfg}
	

	# Comment out below for a faster (no-dialogue) tutorial for testing.
	{./02_Merari_Castle_Dialogues.cfg}

###---=======================================================================---

[scenario]
    id=02_Merari_Castle
    name= _"Black River Tutorial Part II - Merari Castle"
    
###-------------------------------------------------------
    map_data="{~add-ons/Black_River_Tutorial/maps/02_Merari_Castle.map}"
    {~add-ons/Black_River_Tutorial/macros/music-lists.cfg}
###-------------------------------------------------------
    
    turns=26
    next_scenario=03_Southwood

    {DEFAULT_SCHEDULE}
    {MUSIC_IVRIM}
    {MUSICLIST_KHALIFATE}

    [side]
        type=levite_student
        id=student
        name= _"Josh"
        save_id=human_player
        persistent=yes
        canrecruit=yes
        side=1
        gold=123
        controller=human
        recruit=levite,hasmonee,field_paramedic
    [/side]

    [side]
        type=tiv-mudafi
        id=Thrag
        name= _"Thrag"
        side=2
        canrecruit=yes
        recruit=tiv-arif,tiv-rami,tiv-naffat
        gold=0
        {ai/aliases/stable_singleplayer.cfg}
        [ai]
            [aspect]
                id=aggression
                [facet]
                    # When we unleash you, you *will* attack.
                    value=1.0
                    turns=1-6
                [/facet]
            [/aspect]
        [/ai]
    [/side]

    [side]
        no_leader=yes
        side=3
        team_name=1
        controller=null
    [/side]

###-------------------------------------------------------------
# include story from macros/story.cfg

    {BRT_STORY-02_MERARI_CASTLE}

###-------------------------------------------------------------

###---========================== Start of events ===============---	
    [event]
        name=prestart
        [objectives]
            side=1
            [objective]
                description= _"Defeat the Khalifate Leader"
                condition=win
            [/objective]
            [objective]
                [show_if]
                    [variable]
                        name=gender
                        not_equals=female
                    [/variable]
                [/show_if]
                description= _"Death of Matis"
                condition=lose
            [/objective]
            [objective]
                [show_if]
                    [variable]
                        name=gender
                        equals=female
                    [/variable]
                [/show_if]
                description= _"Death of Josh"
                condition=lose
            [/objective]

            {TURNS_RUN_OUT}
        [/objectives]

        [unit]
            id=Ëorendil
            name= _"Ëorendil"
            type=Desert_Captain
            x,y=12,2
            side=3
        [/unit]

        [unit]
            id=Fanatic
            generate_name=yes
            type=tiv-arif
            x,y=8,13
            side=2
            # Make sure the two archers can't take him out!
            [modifications]
                {TRAIT_RESILIENT}
            [/modifications]
        [/unit]
    [/event]

    [event]
        name=start

        {VARIABLE fanatic_dead 0}
        {VARIABLE villages_around_keep 0}
        {VARIABLE village_warn 0}
        {VARIABLE recruit_num 1}
        {VARIABLE income_exceeded 0}
        {STUDENT (_"Ho, Ëorendil! Rav sends me! Has he kabbalahed some more marvellous golems to beat me with? A golem made of rubies, perhaps?")}
# wmlindent: start ignoring
        {GENDER ({TEACHER (_"This is no game, Matis! " +
            _"Khalifates have encamped across the river. They cut our great trees of life, loved by us,  and burn our woods with flammable naphtha for no reason. They only love gold, the desert, horses and their flammable liquid hydrocarbons. Some say they are involve in slave trade, also. They've become a menace to all other cultures and especially to woodland ecosystems.")}) ({TEACHER (_"This is no game, Josh! " +
            _"Khalifates have encamped across the river. They cut our great trees of life, loved by us,  and burn our woods with flammable naphtha for no reason. They only love gold, the desert, horses and their flammable liquid hydrocarbons. Some say they are involve in slave trade, also. They've become a menace to all other cultures and especially to woodland ecosystems.")})}
# wmlindent: stop ignoring
		{TEACHER (_"I do not know why they are now fighting us. In former times they were much more peaceful. 	Behold, this is elven border-country under your peoples protection since millenia. They are fools to enter here, and try to conquer us. We Elves are an old, proud and mighty people, fast and hard to hit in forests. Your people roam the sands unsurpassed. United we shall defend our homes and families against fanatism. We must defeat their fanatic leader so they never threaten us again. I will advise you.")}
        {STUDENT (_"What should I do?")}

        # Now we’re into it... start music.
        {MUSICLIST_KHALIFATE}

        {TALK_ABOUT Fanatic (_"First, we will have to deal with the khalifate Arif stationed in the middle of the river. He should be little trouble.")}
        {TALK_ABOUT Thrag (_"By then, their leader will have recruited more units to send against us and the real fight will begin.")}
        {LABEL (_"Shallow") 19,16}
        {LABEL (_"Shallow") 18,16}
        {LABEL (_"Shallow") 18,14}
        {LABEL (_"Shallow") 19,15}
        {LABEL (_"Shallow") 20,14}
        {LABEL (_"Deep water") 13,16}
        {LABEL (_"Deep water") 20,16}
        {LABEL (_"Deep water") 4,14}

        {TALK_ABOUT_LOC 19,14 (_"See this dark blue water? It’s too deep for either side to cross. The khalifates could slowly wade through that narrow band of shallow lighter-blue water in the east; but we could stand on the shore and force them to fight us from the water, where they are exposed and we are protected by the forest.")}
        {UNLABEL 19,16}
        {UNLABEL 18,16}
        {UNLABEL 18,14}
        {UNLABEL 19,15}
        {UNLABEL 20,14}
        {UNLABEL 13,16}
        {UNLABEL 20,16}
        {UNLABEL 4,14}
        {LABEL (_"Village") 11,14}
        {TALK_ABOUT_LOC 9,14 (_"The more likely attack, then, is across the bridge. That middle island is the key: it has a village for healing injured units and forests in which we fight so well.")}
        {UNLABEL 11,14}
# wmlindent: start ignoring
        {TEACHER (_"To start, we will need some units:
two Levite fighters
two Hasmonee archers
one Field Paramedic healer")}
# wmlindent: stop ignoring

        # See if there are two fighters worth recalling
        [store_unit]
            variable=recall
            [filter]
                x,y=recall,recall
            [/filter]
        [/store_unit]

        # Higher Level units should come first.
        {VARIABLE recall_xp1 0}
        {VARIABLE recall_xp2 0}
        {FOREACH recall i}
            {VARIABLE temp_xp $recall[$i].experience}
            {VARIABLE_OP temp_xp add $recall[$i].variables.previous_xp}
            [if]
                [variable]
                    name=temp_xp
                    greater_than=$recall_xp1
                [/variable]
                [then]
                    # Move anything from slot 1 to slot 2
                    [if]
                        [variable]
                            name=recall_xp1
                            greater_than=0
                        [/variable]
                        [then]
                            {VARIABLE_OP recall_i2 value $recall_i1}
                            {VARIABLE_OP recall_xp2 value $recall_xp1}
                        [/then]
                    [/if]

                    {VARIABLE_OP recall_i1 value $i}
                    {VARIABLE_OP recall_xp1 value $temp_xp}
                [/then]
                [else]
                    [if]
                        [variable]
                            name=temp_xp
                            greater_than=$recall_xp2
                        [/variable]
                        [then]
                            {VARIABLE_OP recall_i2 value $i}
                            {VARIABLE_OP recall_xp2 value $temp_xp}
                        [/then]
                    [/if]
                [/else]
            [/if]
        {NEXT i}
        {CLEAR_VARIABLE i}

        [if]
            [variable]
                name=recall_xp1
                greater_than=0
            [/variable]
            [then]
                {VARIABLE_OP recall_name1 value $recall[$recall_i1].name}
                [if]
                    [variable]
                        name=recall_xp2
                        greater_than=0
                    [/variable]
                    [then]
                        {VARIABLE_OP recall_name2 value $recall[$recall_i2].name}
                        # We have two worth recalling.
                        [if]
                            [variable]
                                name=recall_xp1
                                equals=$recall_xp2
                            [/variable]
                            [then]
                                {TEACHER (_"During your tutorial, both $recall_name1 and $recall_name2 gained $recall_xp1 experience points. You should <i>recall</i> them now so they can gain more experience, rather than recruiting new Levites.")}
                            [/then]
                            [else]
                                {TEACHER (_"During your tutorial, $recall_name1 gained $recall_xp1 experience points, and $recall_name2 gained $recall_xp2. You should <i>recall</i> them now so they can gain more experience, rather than recruiting new Levites.")}
                            [/else]
                        [/if]
                    [/then]
                    [else]
                        # We have one worth recalling.
                        {TEACHER (_"During your tutorial, $recall_name1 gained $recall_xp1 experience points. You should recall that unit now, and recruit a second one (which is cheaper than recalling, anyway).")}
                    [/else]
                [/if]
                {LABEL (_"RECALL $recall_name1") 11,3}
                {PRINT (_"Right click on the tile north-east of you and <i>recall</i> $recall_name1")}
            [/then]
            [else]
                [if]
                    [variable]
                        name=recall.length
                        greater_than=0
                    [/variable]
                    [then]
                        {TEACHER (_"If any levites from your last battle had experience, we would <i>recall</i> them to the current battlefield. However, your veterans gained no experience so it’s cheaper to recruit new units instead. Recruit an levite.")}
                    [/then]
                    [else]
                        {TEACHER (_"If you had any experienced units alive from your last battle we would <i>recall</i> them. Instead we must recruit some new levites.")}
                    [/else]
                [/if]
                {LABEL (_"levite") 11,3}
                {PRINT (_"Right click on the tile north-east of you and recruit an levite")}
            [/else]
        [/if]
    [/event]

    # Check they recall/recruit correctly in their first turn.
    [event]
        name=recruit,recall
        first_time_only=no
        [filter]
            side=1
        [/filter]

        [if]
            [variable]
                name=recruit_num
                less_than=6
            [/variable]
            [then]
                # What did they recruit?
                [store_unit]
                    variable=recruit
                    kill=yes
                    [filter]
                        x,y=$x1,$y1
                    [/filter]
                [/store_unit]
            [/then]
        [/if]

        [if]
            {NUMEQ recruit_num 5}
            [then]
                [if]
                    [variable]
                        name=recruit.type
                        not_equals=field_paramedic
                    [/variable]
                    [then]
                        {REFUND_AND_REMOVE_RECRUIT}
                        {TEACHER (_"No! I said recruit an Ivrim <i>Paramedic</i>! Now try again...")}
                    [/then]
                    [else]
                        [unstore_unit]
                            variable=recruit
                        [/unstore_unit]
                        {VARIABLE_OP recruit_num add 1}
                        {UNLABEL 10,2}
                        {CLEAR_PRINT}
                        {TEACHER (_"The Paramedic is a fairly weak unit, but he has the ability to <i>heal</i> friendly units +4 HP per round standing on hexes around him at the beginning of a new turn.")}
                        {STUDENT (_"So, should I end my turn now?")}
                        # FIXME: If any level 2 units, costs will be higher.
                        {TEACHER (_"While none of your recruited units can move, you still can. Your five units cost you 5 gold in upkeep, leaving you 3 gold poorer per turn. You need more income.")}
# wmlindent: start ignoring
                        {GENDER ({PRINT (_"Move Matis to capture a village")})
                                ({PRINT (_"Move Josh to capture a village")})}
# wmlindent: stop ignoring
                    [/else]
                [/if]
            [/then]
        [/if]

        [if]
            {NUMEQ recruit_num 4}
            [then]
                [if]
                    [variable]
                        name=recruit.type
                        not_equals=hasmonee
                    [/variable]
                    [then]
                        {REFUND_AND_REMOVE_RECRUIT}
                        {TEACHER (_"No! I said recruit an Ivrim <i>Hasmonee</i>! Now try again...")}
                    [/then]
                    [else]
                        {VARIABLE_OP recruit_num add 1}
                        [unit]
                            id=Eol
                            name= _"Eol"
                            type=hasmonee
                            x,y=$x1,$y1
                            side=1
                            gender=female
                            moves=0
                            [modifications]
                                {TRAIT_QUICK}
                                {TRAIT_RESILIENT}
                            [/modifications]
                        [/unit]
                        {EXPLAIN_QUICK_RESILIENT (_"Eol")}

                        {UNLABEL 9,4}
                        {UNLABEL 9,3}
                        {LABEL (_"Paramedic") 10,2}
                        {PRINT (_"Recruit an Ivrim Paramedic to your north")}
                    [/else]
                [/if]
            [/then]
        [/if]

        [if]
            {NUMEQ recruit_num 3}
            [then]
                [if]
                    [variable]
                        name=recruit.type
                        not_equals=hasmonee
                    [/variable]
                    [then]
                        {REFUND_AND_REMOVE_RECRUIT}
                        {TEACHER (_"No! I said recruit an Ivrim <i>Hasmonee</i>! Now try again...")}
                    [/then]
                    [else]
                        {VARIABLE_OP recruit_num add 1}
                        [unit]
                            id=Yitzhaq
                            name= _"Yitzhaq"
                            type=hasmonee
                            x,y=$x1,$y1
                            side=1
                            moves=0
                            [modifications]
                                {TRAIT_STRONG}
                                {TRAIT_INTELLIGENT}
                            [/modifications]
                        [/unit]
                        {EXPLAIN_STRONG_INTELLIGENT (_"Yitzhaq")}
                    [/else]
                [/if]
            [/then]
        [/if]

        [if]
            {NUMEQ recruit_num 2}
            [then]
                [if]
                    [variable]
                        name=recall_xp2
                        greater_than=0
                    [/variable]
                    [then]
                        # You were supposed to recall $recall_name2.
                        [if]
                            [variable]
                                name=recruit.name
                                not_equals=$recall_name2
                            [/variable]
                            [then]
                                {REFUND_AND_REMOVE_RECRUIT}
                                {TEACHER (_"No! I said <i>recall</i> $recall_name2|! Now try again...")}
                            [/then]
                            [else]
                                {VARIABLE_OP recruit_num add 1}
                                [unstore_unit]
                                    variable=recruit
                                [/unstore_unit]
                                {UNLABEL 12,3}
# wmlindent: start ignoring
                                {LABEL (_"Hasmonee  #1") 9,4}
                                {LABEL (_"Hasmonee  #2") 9,3}
# wmlindent: stop ignoring
                                {PRINT (_"Recruit two hasmonees in the tiles to your west")}
                            [/else]
                        [/if]
                    [/then]
                    [else]
                        # You were supposed to recruit a Levite.
                        [if]
                            [variable]
                                name=recruit.type
                                not_equals=levite
                            [/variable]
                            [then]
                                {REFUND_AND_REMOVE_RECRUIT}
                                {TEACHER (_"No! I said recruit an Ivrim <i>Levite</i>! Now try again...")}
                            [/then]
                            [else]
                                {VARIABLE_OP recruit_num add 1}
                                [unit]
                                    id=Avram
                                    name= _"Avram"
                                    type=levite
                                    x,y=$x1,$y1
                                    side=1
                                    moves=0
                                    [modifications]
                                        {TRAIT_QUICK}
                                        {TRAIT_RESILIENT}
                                    [/modifications]
                                [/unit]
                                {EXPLAIN_QUICK_RESILIENT (_"Avram")}

                                {UNLABEL 12,3}
# wmlindent: start ignoring
                                {LABEL (_"Hasmonee #1") 9,4}
                                {LABEL (_"Hasmonee #2") 9,3}
# wmlindent: stop ignoring
                                {PRINT (_"Recruit two hasmonees in the tiles to your west")}
                            [/else]
                        [/if]
                    [/else]
                [/if]
            [/then]
        [/if]

        [if]
            {NUMEQ recruit_num 1}
            [then]
                [if]
                    [variable]
                        name=recall_xp1
                        greater_than=0
                    [/variable]
                    [then]
                        # You were supposed to recall $recall_name1.
                        [if]
                            [variable]
                                name=recruit.name
                                not_equals=$recall_name1
                            [/variable]
                            [then]
                                [if]
                                    [variable]
                                        name=recruit.name
                                        equals=$recall_name2
                                    [/variable]
                                    [then]
                                        {REFUND_AND_REMOVE_RECRUIT}
                                        {TEACHER (_"No! I said recall $recall_name1, not $recall_name2|! Now try again...")}
                                    [/then]
                                    [else]
                                        {REFUND_AND_REMOVE_RECRUIT}
                                        {TEACHER (_"No! I said <i>recall</i> $recall_name1 from the last battle, not recruit a new $recruit.language_name|! Now try again...")}
                                    [/else]
                                [/if]
                            [/then]
                            [else]
                                {VARIABLE_OP recruit_num add 1}
                                {UNLABEL 11,3}
                                [unstore_unit]
                                    variable=recruit
                                [/unstore_unit]
                                [if]
                                    [variable]
                                        name=recall_xp2
                                        greater_than=0
                                    [/variable]
                                    [then]
                                        {PRINT (_"Right click on the tile east of you and recall $recall_name2")}
                                        {LABEL (_"RECALL $recall_name2") 12,3}
                                    [/then]
                                    [else]
                                        {LABEL (_"Levite #1") 12,3}
                                        {PRINT (_"Right click on the tile east of you and recruit an levite")}
                                    [/else]
                                [/if]
                            [/else]
                        [/if]
                    [/then]
                    [else]
                        # You were supposed to recruit a new fighter.
                        # FIXME: How do we tell if they recalled instead?
                        [if]
                            [variable]
                                name=recruit.type
                                not_equals=levite
                            [/variable]
                            [or]
                                [variable]
                                    # FIXME: not a perfect indicator of recall
                                    name=recruit.experience
                                    greater_than=0
                                [/variable]
                            [/or]
                            [then]
                                {REFUND_AND_REMOVE_RECRUIT}
                                {TEACHER (_"$recruit.language_name|? I said <i>recruit</i> a new <i>levite</i>. Now try again...")}
                            [/then]
                            [else]
                                {UNLABEL 11,3}
                                {VARIABLE_OP recruit_num add 1}
                                [unit]
                                    id=Jeremy
                                    name= _"Jeremy"
                                    type=levite
                                    x,y=$x1,$y1
                                    side=1
                                    moves=0
                                    [modifications]
                                        {TRAIT_STRONG}
                                        {TRAIT_INTELLIGENT}
                                    [/modifications]
                                [/unit]
                                {EXPLAIN_STRONG_INTELLIGENT (_"Jeremy")}
                                {LABEL (_"Levite #2") 12,3}
                                {PRINT (_"Right click on the tile east of you and recruit an levite")}
                            [/else]
                        [/if]
                    [/else]
                [/if]
            [/then]
        [/if]
        {CLEAR_VARIABLE recruit}
    [/event]

    [event]
        name=capture
        [filter]
            x=7,9,13
            y=4,2,3
            id=student
        [/filter]
        first_time_only=no

        [allow_undo][/allow_undo]
        # FIXME: If they somehow capture a village near keep, count could be wrong.
        {VARIABLE_OP villages_around_keep add 1}
        [if]
            {NUMEQ villages_around_keep 1}
            [then]
# wmlindent: start ignoring
                # FIXME: Level 2 units change costs.
        {GENDER ({TEACHER (_"You’ve learned well, Matis! " +
                  _"The village supports one unit and pays 1 gold per turn. You’re only losing 1 gold per turn now.")})
                ({TEACHER (_"You’ve learned well, Josh! " +
                  _"The village supports one unit and pays 1 gold per turn. You’re only losing 1 gold per turn now.")})}
# wmlindent: stop ignoring
                {PRINT (_"End your turn")}
            [/then]
        [/if]
        [if]
            {NUMEQ villages_around_keep 3}
            [then]
                {TEACHER (_"You’ve captured all the villages around the keep, but stay near so you can recruit more units.")}
            [/then]
        [/if]
    [/event]

    [event]
        name=capture
        [filter]
            x=7,9,13
            y=4,2,3
            side=1
            [not]
                id=student
            [/not]
        [/filter]
        {GENDER ({TEACHER (_"You should leave the villages near your keep for Matis to capture. He needs to stay nearby to recruit more units anyway.")})
        ({TEACHER (_"You should leave the villages near your keep for Josh to capture. He needs to stay nearby to recruit more units anyway.")})}
        {UNDO_REMINDER}
    [/event]

    [event]
        name=turn 2
        {TALK_ABOUT Fanatic (_"Arifs have no ranged attacks, so use your archers against them.")}

        {PRINT (_"Attack the khalifate with an Hasmonee")}
        {NARRATOR _"Unit Summaries" _"To review the capabilities of any unit—including an enemy—hover the mouse over it, and you will see a unit summary on the right of the screen"}

        [event]
            name=moveto
            [filter]
                x=8,10
                y=8,8
            [/filter]
            {TEACHER (_"Good. Ivrim are are well-protected in sands and dunes. Beware, there’s a 60% chance of hitting an hasmonee in that grassland tile.")}
        [/event]
        [event]
            name=moveto
            [filter]
                x,y=9,8
                side=1
            [/filter]
            [allow_undo][/allow_undo]
            {TEACHER (_"It’s very dangerous to stand in water when there are enemies about! Your unit will have an 80% chance of being hit when the enemy counter-attacks! Cancel!")}
            {UNDO_REMINDER}
        [/event]

        [event]
            name=attack_end
            {PRINT (_"Attack the khalifate with the other Hasmonee")}

            # FIXME: Can't nest events of same type: they both fire 8(
            # So set up this event on next attack.
            [event]
                name=attack

                [event]
                    name=attack_end

                    {CLEAR_PRINT}
                    {UNLABEL 14,3}
                    {LABEL (_"Levite to HERE") 19,5}
                    {TALK_ABOUT_LOC 19,5 (_"Your other units cannot reach the khalifate this turn. Send a Levite to the village in the far east of the map. It will take two turns to reach it.")}
                    {NARRATOR _"Long-distance Movement" _"You can order a unit to move for multiple turns by selecting the unit and clicking on the destination. A number will indicate how many turns it will take to get there."}
                    {PRINT (_"Tell a Levite to move to the far east village")}

                    [event]
                        name=moveto
                        [filter]
                            x,y=19,5
                        [/filter]
                        {UNLABEL 19,5}
                    [/event]
                    [event]
                        name=moveto
                        [filter]
                            x=15-19
                            y=1-6
                        [/filter]

                        {UNLABEL 19,5}
                        {LABEL (_"Keep") 10,3}
                        {TEACHER (_"Send the other Levite and the Paramedic south so they can attack next turn, then return to the keep to recruit more units!")}
                        {GENDER ({PRINT (_"Move your Levite and Paramedic south, then return Matis to the keep")})
                        ({PRINT (_"Move your Levite and Paramedic south, then return Josh to the keep")})}
                    [/event]

                    [event]
                        name=moveto
                        [filter]
                            side=1
                            x,y=10,3
                        [/filter]
                        {UNLABEL 10,3}
                        {PRINT (_"Recruit another Hasmonee and a Levite")}
                        {VARIABLE num_recruited 0}
                    [/event]

                    [event]
                        name=recruit
                        first_time_only=no
                        [filter]
                            side=1
                        [/filter]
                        {UNLABEL 11,3}
                        {VARIABLE_OP num_recruited add 1}
                        [if]
                            {NUMEQ num_recruited 2}
                            [then]
                                {STUDENT (_"I have no more money to recruit!")}
                                {TEACHER (_"That is often a problem, which is why owning villages is important.")}
                                {GENDER ({PRINT (_"Move Matis to another (unowned) village")})
                                ({PRINT (_"Move Josh to another (unowned) village")})}
                            [/then]
                        [/if]
                    [/event]
                    [event]
                        name=moveto
                        [filter]
                            x=7,9,13
                            y=4,2,3
                            id=student
                        [/filter]
                        {PRINT (_"End your turn")}
                    [/event]
                [/event]
            [/event]
        [/event]
    [/event]

    [event]
        name=turn 3

        {UNLABEL 11,3}
        {UNLABEL 12,3}

        # Explain: Zone of Control
        {TALK_ABOUT Fanatic (_"That Arif is blocking the bridge! We must occupy that island before the Ramis reach it.")}
        {STUDENT (_"Can’t our units just move around him?")}

        # All around Fanatic (9,14)
        {LABEL (_"ZoC") 10,14}
        {LABEL (_"ZoC") 8,14}
        {LABEL (_"ZoC") 9,13}
        {LABEL (_"ZoC") 9,15}
        {LABEL (_"ZoC") 10,13}
        {LABEL (_"ZoC") 8,13}
        # FIXME: Figure out best unit choice.
        {TALK_ABOUT Fanatic (_"No. Once you move close to an enemy unit, you are in its <i>Zone of Control</i> and cannot move further that turn.
To move your troops onto that island without wading slowly through the water, you’ll have to kill the Arif.")}
        {PRINT (_"Attack the khalifate with an Hasmonee")}
        {UNLABEL 10,14}
        {UNLABEL 8,14}
        {UNLABEL 9,15}
        {UNLABEL 9,13}
        {UNLABEL 10,13}
        {UNLABEL 8,13}

        [event]
            name=attack_end

            [filter_second]
                id=Fanatic
            [/filter_second]

            {CLEAR_PRINT}
            [store_unit]
                variable=fanatic
                kill=no
                [filter]
                    id=Fanatic
                [/filter]
            [/store_unit]
            # This happens before kill event, so we must do this the hard way.
            [if]
                [variable]
                    name=fanatic.hitpoints
                    less_than=1
                [/variable]
                [then]
                    {PRINT (_"Advance other units and capture villages, then <b>End Turn</b>")}
                [/then]
                [else]
                    [if]
                        [variable]
                            name=unit.gender
                            equals=male
                        [/variable]
                        [then]
                            #po: The unit with unit type $unit.language_name is male.
                            {STUDENT (_"No other units can reach that khalifate. I hope my $unit.language_name survives its counter-attack! I’d better grab more villages and move everyone closer for next turn.")}
                        [/then]
                        [else]
                            #po: The unit with unit type $unit.language_name is female.
                            {STUDENT (_"female^No other units can reach that khalifate. I hope my $unit.language_name survives its counter-attack! I’d better grab more villages and move everyone closer for next turn.")}
                        [/else]
                    [/if]
                    {TEACHER (_"Yes. If your Paramedic stands just behind that unit on the bridge, he will heal it at the beginning of the next turn.")}
                    {PRINT (_"Move your Paramedic onto the bridge to stand behind your other unit")}
                    [event]
                        name=moveto
                        [filter]
                            type=field_paramedic
                        [/filter]
                        {PRINT (_"Advance other units and capture villages, then <b>End Turn</b>")}
                    [/event]
                [/else]
            [/if]
            {CLEAR_VARIABLE fanatic}
        [/event]
    [/event]

    [event]
        name=die
        [filter]
            id=Fanatic
        [/filter]
        {VARIABLE fanatic_dead 1}
        # Only tell them to defend island if not turn 3.
        [if]
            [variable]
                name=turn_number
                greater_than=3
            [/variable]
            [then]
                {DEFEND_ISLAND}
            [/then]
        [/if]

        [event]
            name=moveto
            [filter]
                x=9,9,9
                y=15,16,17
                side=1
            [/filter]

            [allow_undo][/allow_undo]
            [if]
                [variable]
                    name=turn_number
                    less_than=8
                [/variable]
                [then]
                    {TALK_NO_MOVE (_"Be careful: if you stand on the bridge you are exposed to attack from multiple directions!")}
                    {UNDO_REMINDER}
                [/then]
            [/if]
        [/event]

        [event]
            name=moveto
            [filter]
                x=8,10,18,19,20,11
                y=14,15,14,15,14,15
                side=1
            [/filter]
            {TEACHER (_"It’s very dangerous to stand in water when there are enemies about! Your unit will have an 80% chance of being hit! Cancel, and wait for them to attack you!")}
            {UNDO_REMINDER}
            [allow_undo][/allow_undo]
        [/event]
    [/event]

    [event]
        name=turn 4

        {CLEAR_PRINT}
        {TALK_ABOUT_LOC 19,5 (_"Don’t forget about your Levite in the east; you can move him south to that last village near the channel.")}
        [allow_undo][/allow_undo]
        [if]
            {NUMEQ fanatic_dead 0}
            [then]
                {TALK_ABOUT Fanatic (_"We need to occupy that village, otherwise they will take it next turn! Move a unit into the village to stop the khalifates capturing it. Whichever unit you choose will benefit from the village’s healing, too.")}
            [/then]
            [else]
                {DEFEND_ISLAND}
            [/else]
        [/if]
    [/event]

    [event]
        name=turn 5

        {DEFEND_ISLAND}
        {TALK_ABOUT_LOC 11,14 (_"Careful! It is now nighttime. Khalifates are <i>liminal</i>, which means their attacks are now 25% weaker. By day, their attacks are 25% weaker, as well. Only in times of dusk or dawn they do not suffer attack strength (+- 0%), which is a noticeable difference. Some units are <i>lawful</i>: stronger by day and weaker at night. Others are <i>chaotic</i>: stronger by nigfht and weaker at day. Some units are <i>neutral</i>: unaffected by the time of day.")}
        {NARRATOR _"Time of Day" _"After this dialog, hold the mouse over the landscape image below the minimap on the right. This brings up a description of the time of day, showing who has the advantage."}
    [/event]

    [event]
        name=turn 6

        {CHECK_INCOME}
        {TALK_ABOUT_LOC 9,15 (_"Remember to retreat your wounded units to villages. Paramedics can only heal +4 hitpoints at a time, while villages can heal 8 (the maximum healing for any unit).")}
    [/event]

    [event]
        name=turn 7

        {CHECK_INCOME}
        {LABEL (_"Defend here") 19,14}
        {TALK_ABOUT_LOC 19,16 (_"Beware of those khalifates crossing the river! If they get into the forest they’ll be hard to dislodge!")}
    [/event]

    [event]
        name=turn 9
        {UNLABEL 19,14}
        {NARRATOR _"Tracking Unused Units" _"You can ensure you use all your troops by pressing <b>n</b> to step from one unit to the next. If you press <b>space</b>, you can mark the currently selected unit as having finished its turn, which stops you moving it by accident later on. When <b>n</b> no longer selects a new unit, it’s safe to end your turn."}
    [/event]

    [event]
        name=turn 10
        {NARRATOR _"Victory Conditions" _"In this scenario, you only need to defeat the khalifate leader to win. (Victory conditions for a scenario are given under <b>Scenario Objectives</b> in the <b>Main Menu</b>)."}
    [/event]

    [event]
        name=turn 12
        {NARRATOR _"Recruit the Right Unit Types" _"Remember to recruit troops useful for the situation. Hasmonees are particularly effective against Arifs, Ramis and the Khalifate leader."}
    [/event]

    # Remind them to keep back
    [event]
        name=moveto
        [filter]
            id=student
            x=1-20
            y=6-20
        [/filter]

        [if]
            [variable]
                name=turn_number
                less_than=8
            [/variable]
            [then]
                {TEACHER (_"Stay near the keep! You need to be on a keep to recruit more units, and I doubt the khalifate leader will let you use his!")}
            [/then]
        [/if]
        [allow_undo][/allow_undo]
    [/event]

    [event]
        name=moveto
        [filter]
            id=Thrag
            x=5,14,19
            y=19,19,23
        [/filter]

        {TALK_ABOUT Thrag (_"Their leader has moved into that village! He’s not as stupid as I thought. The village heals him each turn and provides good defense.")}
    [/event]


###-----------------------------------------------------------------------------
    [event]
        name=moveto
        [filter]
            side=2
            x=11,6,11
            y=14,10,10
        [/filter]

        {TALK_ABOUT_LOC ($x1,$y1) (_"That unit has captured our village! You’d better get him out; it heals him each turn and provides good defense.")}
    [/event]

    # Warn about using shaman to attack.
    [event]
        name=attack
        [filter]
            type=field_paramedic
        [/filter]

        [message]
            speaker=unit
            message= _"Using me to attack is risky! I can slow the opponent with my ranged attack, but I hope you have a plan if I miss!"
        [/message]
    [/event]

#Dialogues in case Unit Thrag is close to die (about gaining XP)
###-----------------------------------------------------------------------------
    [event]
        name=attack_end
        first_time_only=no

        [store_unit]
            variable=attacker
            [filter]
                x,y=$x1,$y1
            [/filter]
        [/store_unit]
        [store_unit]
            variable=defender
            [filter]
                x,y=$x2,$y2
            [/filter]
        [/store_unit]

        {DEFENDER_INJURED defender}
        {IMPORTANT_UNIT attacker}

        [if]
            [variable]
                name=attacker.id
                equals=Thrag
            [/variable]
            [variable]
                name=attacker.hitpoints
                less_than=21
            [/variable]
            {NUMEQ talk_about_killing_thrag 0}
            [then]
                {VARIABLE talk_about_killing_thrag 1}
                {TALK_ABOUT Thrag (_"You are close to killing their leader! The unit who finishes him will gain 16 experience points because he is second level. Choose your attacking unit carefully!")}
            [/then]
        [/if]
        [if]
            [variable]
                name=defender.id
                equals=Thrag
            [/variable]
            [variable]
                name=defender.hitpoints
                less_than=21
            [/variable]
            {NUMEQ talk_about_killing_thrag 0}
            [then]
                {VARIABLE talk_about_killing_thrag 1}
                {TALK_ABOUT Thrag (_"You are close to killing their leader! The unit who finishes him will gain 16 experience points because he is second level. Choose your attacking unit carefully!")}
            [/then]
        [/if]
        {CLEAR_VARIABLE attacker}
        {CLEAR_VARIABLE defender}
    [/event]
    
# Dialogues if some of our own units will die
###-----------------------------------------------------------------------------
    [event]
        name=die
        first_time_only=no
        [filter]
            side=1

            [not]
                id=student
            [/not]
        [/filter]

        [store_unit]
            variable=deadguy
            [filter]
                x,y=$x1,$y1
            [/filter]
        [/store_unit]

        [if]
            [variable]
                name=deadguy.type
                equals=levite
            [/variable]
            [or]
                [variable]
                    name=deadguy.type
                    equals=hasmonee
                [/variable]
            [/or]
            [then]
                [if]
                    [variable]
                        name=deadguy.experience
                        greater_than=20
                    [/variable]
                    [then]
                        [if]
                            [variable]
                                name=deadguy.gender
                                equals=male
                            [/variable]
                            [then]
                                {TEACHER (_"We will miss $deadguy.name| because he had $deadguy.experience experience points. He would have advanced to second level soon.")}
                            [/then]
                            [else]
                                {TEACHER (_"We will miss $deadguy.name| because he had $deadguy.experience experience points. He would have advanced to second level soon.")}
                            [/else]
                        [/if]
                    [/then]
                    [else]
                        [if]
                            [variable]
                                name=deadguy.experience
                                less_than=8
                            [/variable]
                            [then]
                                [if]
                                    [variable]
                                        name=deadguy.gender
                                        equals=male
                                    [/variable]
                                    [then]
                                        {TEACHER (_"We will miss $deadguy.name|, but at least he was not one of our experienced troops!")}
                                    [/then]
                                    [else]
                                        {TEACHER (_"We will miss $deadguy.name|, but at least he was not one of our experienced troops!")}
                                    [/else]
                                [/if]
                            [/then]
                        [/if]
                    [/else]
                [/if]
            [/then]
            [else]
                [if]
                    [variable]
                        name=deadguy.type
                        equals=field_paramedic
                    [/variable]
                    [then]
                        {TEACHER (_"Losing a healer hurts all the troops! Keep them out of the enemy’s reach!")}
                        {NARRATOR _"Tracking Enemy Movement" _"You can see where an enemy can reach by moving the mouse over them. You can see all possible enemy moves at once with the <b>Show Enemy Moves</b> command from the <b>Actions</b> menu."}
                    [/then]
                    [else]
                        # Must be level 2 unit.
                        {TEACHER (_"Second level units are powerful, but not invulnerable! Goodbye, $deadguy.name|.")}
                    [/else]
                [/if]
            [/else]
        [/if]
        {CLEAR_VARIABLE deadguy}
    [/event]

    [event]
        name=moveto
        [filter]
            side=1
            x=1-13
            y=18-21
        [/filter]
        {TALK_ABOUT Thrag (_"Beware of the khalifate leader: he can do 28 hitpoints of damage at dusk or dawn! Attack with many units at once during dusk or dawn.")}
    [/event]
    
###-----------------------------------------------------------------------------
# What if the player levels up the Paramedic?
    [event]
        name=post_advance
        [filter]
            side=1
            type=field_resident
        [/filter]
        # FIXME: Abilities.
        [if]
            [variable]
                name=unit.gender
                equals=male
            [/variable]
            [then]
                [message]
                    speaker=unit
                    #wmllint: display on
                    message= _"Advancing a level has fully healed me!
As a Resident I can now heal +6 HP with my <i>Paramedic</i> ability, and I deal 7 melee or 8 ranged damage, respectively, each for 3 attacks in one round. Use me to finish wounded enemy units or to heal off the front line in combat situations."
                    #wmllint: display off
                [/message]
            [/then]
            [else]
                [message]
                    speaker=unit
                    #wmllint: display on
                    message= _"female^Advancing a level has fully healed me!
As a Resident I can now heal +6 HP with my <i>Paramedic</i> ability, and I deal 7 melee or 8 ranged damage, respectively, each for 3 attacks in one round. Use me to finish wounded enemy units or to heal off the front line in combat situations."
                    #wmllint: display off
                [/message]
            [/else]
        [/if]
    [/event]
###-----------------------------------------------------------------------------
# What happens, if the player levels up the Hasmonee (archer)?
    [event]
        name=post_advance
        [filter]
            side=1
            type=hasmonee_rasab
        [/filter]
        [if]
            [variable]
                name=unit.gender
                equals=male
            [/variable]
            [then]
                [message]
                    speaker=unit
                    #wmllint: display on
                    message= _"Advancing a level has fully healed me!
As a Hasmonee Rasab (Sgt. Major) I always have a 60% chance of hitting with my <i>Marksman</i> ability, and I deal 9 melee damage for 3 attacks or 8 ranged damage for 4 attacks per round, respectively. I am swift and sturdy, use me to dislodge hard-to-hit units."
                    #wmllint: display off
                [/message]
            [/then]
            [else]
                [message]
                    speaker=unit
                    #wmllint: display on
                    message= _"female^Advancing a level has fully healed me!
As a Hasmonee Rasab (Sgt. Major) I always have a 60% chance of hitting with my <i>Marksman</i> ability, and I deal 9 melee damage for 3 attacks or 8 ranged damage for 4 attacks per round, respectively. I am swift and sturdy, use me to dislodge hard-to-hit units."
                    #wmllint: display off
                [/message]
            [/else]
        [/if]
    [/event]
###-----------------------------
    [event]
        name=post_advance
        [filter]
            side=1
            type=hasmonee_saal
        [/filter]
        [if]
            [variable]
                name=unit.gender
                equals=male
            [/variable]
            [then]
                [message]
                    speaker=unit
                    #wmllint: display on
                    message= _"Advancing a level has fully healed me!
As a Hasmonee Saal (Lt. Colonel) I have leadership abilities, and I deal 14 melee damage for 3 attacks per round. I am a platoon leader, fighting better with a hasmonee brothers at my side. I do not have a ranged attack therefor I am vulnerable to that kind of attack. Use me in combination with other units next to me at the front line in combat situations."
                    #wmllint: display off
                [/message]
            [/then]
            [else]
                [message]
                    speaker=unit
                    #wmllint: display on
                    message= _"female^Advancing a level has fully healed me!
As a Hasmonee Saal (Lt. Colonel) I have leadership abilities, and I deal 14 melee damage for 3 attacks per round. I am a platoon leader, fighting better with a hasmonee brothers at my side. I do not have a ranged attack therefor I am vulnerable to that kind of attack. Use me in combination with other units next to me at the front line in combat situations."
                    #wmllint: display off
                [/message]
            [/else]
        [/if]
    [/event]
###-----------------------------    
    [event]
        name=post_advance
        [filter]
            side=1
            type=hasmonee_abir
        [/filter]
        [if]
            [variable]
                name=unit.gender
                equals=male
            [/variable]
            [then]
                [message]
                    speaker=unit
                    #wmllint: display on
                    message= _"Advancing a level has fully healed me!
As a Hasmonee Abir (Brave) I can now heal friendly units from poison with my <i>Detox</i> ability, and I deal 16 melee damage for 2 attacks per round. I do not have a ranged attack therefor I am vulnerable to that kind of attack. Use me to level up in the abir line, to finish vulnerable enemies, or to detoxicate poisoned units."
                    #wmllint: display off
                [/message]
            [/then]
            [else]
                [message]
                    speaker=unit
                    #wmllint: display on
                    message= _"female^As a Hasmonee Abir (Brave) I can now heal friendly units from poison with my <i>Detox</i> ability, and I deal 16 melee damage for 2 attacks per round. I do not have a ranged attack therefor I am vulnerable to that kind of attack. Use me to level up in the abir line, to finish vulnerable enemies, or to detoxicate poisoned units."
                    #wmllint: display off
                [/message]
            [/else]
        [/if]
    [/event]
###-----------------------------    
    [event]
        name=post_advance
        [filter]
            side=1
            type=hasmonee_spy
        [/filter]
        [if]
            [variable]
                name=unit.gender
                equals=male
            [/variable]
            [then]
                [message]
                    speaker=unit
                    #wmllint: display on
                    message= _"Advancing a level has fully healed me!
As a Hasmonean Spy I can hide in deserts and woods with my <i>Deserttarn</i> ability. I also have the <i>Skirmish</i> ability, meaning I can pull off behind enemie lines, ignoring the zones of control of enemy units. Use me to sneak behind the front lines to wreck havock or to spy out locations whilst unseen and hidden to the opponent myself."
                    #wmllint: display off
                [/message]
            [/then]
            [else]
                [message]
                    speaker=unit
                    #wmllint: display on
                    message= _"female^Advancing a level has fully healed me!
As a Hasmonean Spy I can hide in deserts and woods with my <i>Deserttarn</i> ability. I also have the <i>Skirmish</i> ability, meaning I can pull off behind enemie lines, ignoring the zones of control of enemy units. Use me to sneak behind the front lines to wreck havock or to spy out locations whilst unseen and hidden to the opponent myself."
                    #wmllint: display off
                [/message]
            [/else]
        [/if]
    [/event]   
###----------------------------------------------------------------------------- 
# What happens, if the player levels up the Levite (fighter)?
    [event]
        name=post_advance
        [filter]
            side=1
            type=levite_saal
        [/filter]
        [if]
            [variable]
                name=unit.gender
                equals=male
            [/variable]
            [then]
                [message]
                    speaker=unit
                    #wmllint: display on
                    message= _"Advancing a level has fully healed me!
As a Levite Saal (Lt. Colonel) I have a field grade officers rank. 
can now heal +6 HP my <i>Paramedic</i> ability, and I deal 10 melee or 13 ranged damage each for 3 or 2 attacks per round, respectively. In melee combat situations I always strike first with my <i>Firststrike</i> ability. Use me at the front line in combat situations, most effectively in combination with a unit with leadership abilities next to me and a paramedic behind."
                    #wmllint: display off
                [/message]
            [/then]
            [else]
                [message]
                    speaker=unit
                    #wmllint: display on
                    message= _"female^Advancing a level has fully healed me!
As a Levite Saal (Lt. Colonel) I have a field grade officers rank. 
can now heal +6 HP my <i>Paramedic</i> ability, and I deal 10 melee or 13 ranged damage each for 3 or 2 attacks per round, respectively. In melee combat situations I always strike first with my <i>Firststrike</i> ability. Use me at the front line in combat situations, most effectively in combination with a unit with leadership abilities next to me and a paramedic behind."
                    #wmllint: display off
                [/message]
            [/else]
        [/if]
    [/event]
###-----------------------------    
    [event]
        name=post_advance
        [filter]
            side=1
            type=levite_taal
        [/filter]
        [if]
            [variable]
                name=unit.gender
                equals=male
            [/variable]
            [then]
                [message]
                    speaker=unit
                    #wmllint: display on
                    message= _"Advancing a level has fully healed me!
As a Levite Taal (Brigadier-General) I have a low general officers rank. I deal 15 melee damage for 2 attacks per round. I do not have a ranged attack therefor I am vulnerable to that kind of attack. With my <i>Leadership</i> ability I do inspire friendly units next to me to fight better, gaining them +25% attack strength times the difference in level. Use me at the front line in combat situations, most effectively in combination with other units that posses a ranged attack next to me and a paramedic behind."
                    #wmllint: display off
                [/message]
            [/then]
            [else]
                [message]
                    speaker=unit
                    #wmllint: display on
                    message= _"female^As a Levite Taal (Brigadier-General) I have a low general officers rank. I deal 15 melee damage for 2 attacks per round. I do not have a ranged attack therefor I am vulnerable to that kind of attack. With my <i>Leadership</i> ability I do inspire friendly units next to me to fight better, gaining them +25% attack strength times the difference in level. Use me at the front line in combat situations, most effectively in combination with other units that posses a ranged attack next to me and a paramedic behind."
                    #wmllint: display off
                [/message]
            [/else]
        [/if]
    [/event]
###-----------------------------    
    [event]
        name=post_advance
        [filter]
            side=1
            type=sgan_kohen
        [/filter]
        [if]
            [variable]
                name=unit.gender
                equals=male
            [/variable]
            [then]
                [message]
                    speaker=unit
                    #wmllint: display on
                    message= _"Advancing a level has fully healed me!
As a Kohen Sgan (Subcommander) I have a low general officers rank. While defending I gain resistance against sword, impakt, pierce, fire, cold and magic attacks in combat situations with my <i>Steadfast</i> ability. I deal 11 melee damage for 3 attacks per round. My pierce attack in combination with my increased steadfastedness makes me a freared opponent to horse lancers and most spearmen. I do fight best in a pallanx, meaning, a line of ivrim longspear kohens holding position against any threat."
                    #wmllint: display off
                [/message]
            [/then]
            [else]
                [message]
                    speaker=unit
                    #wmllint: display on
                    message= _"female^Advancing a level has fully healed me!
As a Kohen Sgan (Subcommander) I have a low general officers rank. While defending I gain resistance against sword, impakt, pierce, fire, cold and magic attacks in combat situations with my <i>Steadfast</i> ability. I deal 11 melee damage for 3 attacks per round. My pierce attack in combination with my increased steadfastedness makes me a freared opponent to horse lancers and most spearmen. I do fight best in a pallanx, meaning, a line of ivrim longspear kohens holding position against any threat."
                    #wmllint: display off
                [/message]
            [/else]
        [/if]
    [/event]
###-----------------------------    
    [event]
        name=post_advance
        [filter]
            side=1
            type=posek
        [/filter]
        [if]
            [variable]
                name=unit.gender
                equals=male
            [/variable]
            [then]
                [message]
                    speaker=unit
                    #wmllint: display on
                    message= _"Advancing a level has fully healed me!
As a Rav Posek (Dezisor) I can conceal myself in villages, castles and keeps with my <i>Scripturestudy</i> ability. Outside of these places I am very vulnerable, so it would be best if other fighters or archers would be near by to guard me. I do not have any attack, but I deal 10 melee damage for 3 attacks per round in defense to enemy attacks. My attacks are based on reciting holy scriptural verses. In the dimension of these holy letters and vovels defensive fire, cold, and arcane is all of the same cosmological reality. Use me to secure villages and cities off the front lines of war."
                    #wmllint: display off
                [/message]
            [/then]
            [else]
                [message]
                    speaker=unit
                    #wmllint: display on
                    message= _"female^Advancing a level has fully healed me!
As a Rav Posek (Dezisor) I can conceal myself in villages, castles and keeps with my <i>Scripturestudy</i> ability. Outside of these places I am very vulnerable, so it would be best if other fighters or archers would be near by to guard me. I do not have any attack, but I deal 10 melee damage for 3 attacks per round in defense to enemy attacks. My attacks are based on reciting holy scriptural verses. In the dimension of these holy letters and vovels defensive fire, cold, and arcane is all of the same cosmological reality. Use me to secure villages and cities off the front lines of war."
                    #wmllint: display off
                [/message]
            [/else]
        [/if]
    [/event]
###----------------------------------------------------------------------------- 

    # WE control the AI! Bwahahaha!
    [event]
        name=side 2 turn refresh
        first_time_only=no
        {CLEAR_PRINT}
        [if]
            {NUMEQ turn_number 1}
            [then]
                # Advance sacrificial khalifate.
                {MOVE Fanatic 8 13 9 9}
                [scroll_to_unit]
                    id=Thrag
                [/scroll_to_unit]
                {BADGUY (tiv-rami) Scout1 17,24}
                {BADGUY (tiv-rami) Scout2 18,23}
                {BADGUY (tiv-rami) Scout3 19,24}
                {BADGUY (tiv-saree) Scout4 17,25}
                {BADGUY (tiv-khaiyal) Scout5 18,25}
                # Leader moves to take village
                {MOVE Thrag 18 24 19 23}
                [capture_village]
                    side=2
                    x,y=19,23
                [/capture_village]
            [/then]
        [/if]
        [if]
            {NUMEQ turn_number 2}
            [then]
                # Khalifate runs away.
                {MOVE Fanatic 9 9 9 14}
                # Riders advance
                [scroll_to_unit]
                    id=Thrag
                [/scroll_to_unit]
                {MOVE Scout1 17 24 13 20}
                {MOVE Scout2 18 23 12 19}
                {MOVE Scout3 19 24 14 20}
                {MOVE Scout4 17 25 10 24}
                {MOVE Scout5 18 25 14 19}
                [capture_village]
                    side=2
                    x,y=14,19
                [/capture_village]
                # Leader move to keep, recruits & advances
                {MOVE Thrag 19 23 18 24}
                {BADGUY (tiv-arif) Grunt1 18,23}
                {BADGUY (tiv-ghazi) Grunt2 17,24}
                {BADGUY (tiv-naffat) Archer1 19,24}
                {MOVE Thrag 18 24 16 20}
            [/then]
        [/if]
        [if]
            {NUMEQ turn_number 3}
            [then]
                {MOVE Scout1 13 20 8 18}
                {MOVE Scout2 12 19 7 18}
                {MOVE Scout3 14 20 9 18}
                {MOVE Scout4 10 24 9 26}
                [capture_village]
                    side=2
                    x,y=9,26
                [/capture_village]
                {MOVE Scout5 14 19 9 17}
                {MOVE Thrag 16 20 11 19}
                {MOVE Grunt1 18 23 15 20}
                {MOVE Archer1 19 24 16 20}
                {MOVE Grunt2 17 24 16 21}
            [/then]
        [/if]

        [if]
            {NUMEQ turn_number 4}
            [then]
                # Leave Scout1 and Scout2 to attack
                {MOVE Scout3 9 18 11 16}
                {MOVE Scout5 9 17 10 16}
                {MOVE Scout4 9 26 6 20}
                {MOVE Thrag 11 19 9 19}
                {MOVE Grunt1 15 20 11 19}
                {MOVE Archer1 16 20 18 17}
                {MOVE Grunt2 16 21 18 18}
            [/then]
        [/if]

        # From now on, we only control these two, down channel
        [if]
            {NUMEQ turn_number 5}
            [then]
                {MOVE Archer1 18 17 18 16}
                {MOVE Grunt2 18 18 18 17}
                # Leaders stays here, to shorten the scenario 8)
                {MOVE Thrag 9 19 9 19}
            [/then]
        [/if]

        [if]
            {NUMEQ turn_number 6}
            [then]
                {MOVE Archer1 18 16 19 16}
                {MOVE Grunt2 18 17 18 16}
                {MOVE Thrag 9 19 9 19}
            [/then]
        [/if]

        [if]
            {NUMEQ turn_number 7}
            [then]
                # Force grunt to advance if poss.
                [if]
                    [not]
                        [have_unit]
                            x,y=19,16
                        [/have_unit]
                    [/not]
                    [then]
                        {MOVE Grunt2 18 16 19 16}
                    [/then]
                    [else]
                        {MOVE Grunt2 18 16 18 16}
                    [/else]
                [/if]
                {MOVE Thrag 9 19 9 19}
            [/then]
        [/if]

        [if]
            {NUMEQ turn_number 8}
            [then]
                # Force grunt to advance if poss.
                [if]
                    [not]
                        [have_unit]
                            x,y=19,16
                        [/have_unit]
                    [/not]
                    [then]
                        {MOVE Grunt2 18 16 19 16}
                    [/then]
                    [else]
                        {MOVE Grunt2 18 16 18 16}
                    [/else]
                [/if]

                # We can now leader move IF they are on bridge
                [if]
                    [not]
                        [have_unit]
                            side=1
                            x=7-11
                            y=16-21
                        [/have_unit]
                    [/not]
                    [then]
                        {MOVE Thrag 9 19 9 19}
                    [/then]
                [/if]
            [/then]
        [/if]
    [/event]

    [event]
        name=time over
        {TEACHER (_"You took too long! We’ll never be rid of these khalifates!")}
        [endlevel]
            result=defeat
        [/endlevel]
    [/event]

    [event]
        name=die
        [filter]
            id=student
        [/filter]
        [endlevel]
            result=defeat
        [/endlevel]
    [/event]

    [event]
        name=defeat
        {CLEAR_PRINT}
    [/event]

    [event]
        name=victory
        {TEACHER (_"You have beaten the khalifates! You may want to rest a short while now and enlist to the defense forces tomorow. The danger is not averted yet.")}
    [/event]
    # Experience tracking needed in Scenario2 code
    # Give them roles of 'Veteran' as well or instead? Lets you track 0XP units cleanly.
    [event]
        name=advance
        first_time_only=no
        {VARIABLE_OP unit.variables.previous_xp add $unit.max_experience}
        [unstore_unit]
            variable=unit
            advance=false
        [/unstore_unit]
    [/event]
[/scenario]
